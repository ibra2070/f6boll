<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Watch</title>
  <style>
    :root { --accent:#00ff88; --bg:#000; --fg:#fff; }
    body { margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .wrap { max-width:960px; margin:0 auto; padding:16px; }
    video { width:100%; height:auto; background:#000; border-radius:12px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:12px; }
    .btn { padding:10px 14px; border:0; border-radius:8px; background:var(--accent); color:#000; font-weight:600; cursor:pointer; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .chip { padding:8px 12px; border-radius:999px; border:1px solid #2a2a2a;color:#fff;background:#111; cursor:pointer; }
    .msg { opacity:.85; font-size:14px; margin-top:8px; }
    a { color: var(--accent); text-decoration:none; }
    .range { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <div class="wrap">
    <video id="video" controls playsinline muted poster="poster.jpg"></video>
    <div id="status" class="msg">Loading…</div>

    <!-- Clipper UI -->
    <div class="row">
      <button id="setA" class="btn">Set Start (A)</button>
      <button id="setB" class="btn">Set End (B)</button>
      <span id="rangeLabel" class="range">A: —  B: —</span>
      <a href="index.html" style="margin-left:auto">← Back</a>
    </div>
    <div class="row">
      <button class="chip" data-preset="15">+15s</button>
      <button class="chip" data-preset="30">+30s</button>
      <button class="chip" data-preset="60">+60s</button>
      <button class="chip" data-preset="120">+120s</button>
      <button id="preview" class="btn">Preview</button>
      <button id="download" class="btn">Download</button>
    </div>
    <div class="msg" id="note">Tip: clips up to 10 minutes export fastest.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const statusEl = document.getElementById('status');
    const video = document.getElementById('video');
    const $setA = document.getElementById('setA');
    const $setB = document.getElementById('setB');
    const $preview = document.getElementById('preview');
    const $download = document.getElementById('download');
    const $range = document.getElementById('rangeLabel');

    const MAX_SECONDS = 600; // 10 min

    // read ?code=
    const params = new URLSearchParams(location.search);
    const code = params.get('code') || '';
    if (!code) {
      statusEl.textContent = 'Missing ?code=…';
      throw new Error('Missing code');
    }

    // Your Worker playlist URL
    const BASE = 'https://fision-videos-worker.myfisionupload.workers.dev';
    const m3u8Url = `${BASE}/videos/${encodeURIComponent(code)}/stream_0.m3u8`;

    function setStatus(t){ statusEl.textContent = t; }

    // ---- Set up HLS playback ----
    if (Hls.isSupported()) {
      const hls = new Hls({ lowLatencyMode: true, enableWorker: true });
      hls.on(Hls.Events.MANIFEST_PARSED, () => setStatus('Ready'));
      hls.on(Hls.Events.ERROR, (_, data) => {
        if (data?.fatal) setStatus('HLS fatal error: ' + data.type);
      });
      hls.loadSource(m3u8Url);
      hls.attachMedia(video);
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = m3u8Url;            // Safari
      video.addEventListener('loadedmetadata', ()=> setStatus('Ready'));
    } else {
      setStatus('HLS not supported in this browser.');
    }

    // ---- Simple preview logic: start looping; auto-cancel on any change ----
    let A = null, B = null;
    let isPreviewing = false;
    let loopCb = null;

    function fmt(t){
      if (t == null) return '—';
      const s = Math.max(0, Math.floor(t));
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${mm}:${ss}`;
    }
    function paint(){ $range.textContent = `A: ${fmt(A)}   B: ${fmt(B)}`; }

    function startPreview() {
      if (A == null || B == null || B <= A) return alert('Set a valid A and B first.');
      stopPreview(false); // ensure clean state
      isPreviewing = true;
      loopCb = () => {
        if (!isPreviewing) return;
        if (video.currentTime >= B - 0.05) video.currentTime = A;
      };
      video.addEventListener('timeupdate', loopCb);
      video.currentTime = A;
      video.play().catch(()=>{});
    }
    function stopPreview(pause = false) {
      if (!isPreviewing) return;
      isPreviewing = false;
      if (loopCb) { video.removeEventListener('timeupdate', loopCb); loopCb = null; }
      if (pause) video.pause();
    }

    $preview.addEventListener('click', () => startPreview());

    // Auto-cancel preview when user "gets out" of setup
    video.addEventListener('seeking', () => stopPreview(false));
    video.addEventListener('pause',   () => stopPreview(false));

    $setA.addEventListener('click', () => {
      stopPreview(false);
      A = video.currentTime;
      if (B != null && B <= A) B = Math.min(A + 5, (video.duration || A + 5));
      paint();
    });
    $setB.addEventListener('click', () => {
      stopPreview(false);
      B = video.currentTime;
      if (A != null && B <= A) A = Math.max(0, B - 5);
      paint();
    });

    document.querySelectorAll('[data-preset]').forEach(btn => {
      btn.addEventListener('click', () => {
        stopPreview(false);
        const n = +btn.dataset.preset;
        if (A == null) A = video.currentTime;
        B = Math.min((video.duration || A + n), A + n);
        paint();
      });
    });

    // ---- Download via serverless API (/api/clip) ----
    $download.addEventListener('click', async () => {
      stopPreview(true); // leave preview mode and pause

      if (A == null || B == null || B <= A) return alert('Set a valid A and B first.');
      const len = B - A;
      if (len > MAX_SECONDS) return alert('Please keep clips ≤ 10 minutes');

      setStatus('Preparing clip…');

      const url = `/api/clip?code=${encodeURIComponent(code)}&start=${A.toFixed(2)}&end=${B.toFixed(2)}`;
      const res = await fetch(url);
      if (!res.ok) {
        const txt = await res.text().catch(()=>res.statusText);
        setStatus('Clip failed');
        return alert('Clip failed: ' + txt);
      }

      const blob = await res.blob();
      const filename = `clip_${code}_${Math.floor(A)}-${Math.floor(B)}.mp4`;

      // Mobile: try native share
      if (navigator.share && blob.type === 'video/mp4') {
        try {
          const file = new File([blob], filename, { type: 'video/mp4' });
          await navigator.share({ files: [file], title: 'Clip' });
          setStatus('Shared!');
          return;
        } catch {}
      }

      // Desktop: force download reliably
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.rel = 'noopener';
      a.style.display = 'none';
      document.body.appendChild(a);
      requestAnimationFrame(() => {
        a.click();
        requestAnimationFrame(() => {
          URL.revokeObjectURL(a.href);
          a.remove();
          setStatus('Downloaded');
        });
      });
    });

    paint();
  </script>
</body>
</html>
