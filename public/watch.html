<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Watch & Download Clip (MP4)</title>
  <style>
    :root { --green:#00ff88; --bg:#0b0b0b; --muted:#9aa1a8; }
    *{box-sizing:border-box}
    body{
      margin:0; background:#0b0b0b url('./background.png') center/cover fixed no-repeat;
      color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell;
      min-height:100dvh; display:flex; flex-direction:column; gap:16px; padding:16px;
      backdrop-filter:brightness(.45);
    }
    .card{ max-width:960px; width:100%; margin:0 auto; background:rgba(0,0,0,.7);
      border-radius:16px; padding:16px; box-shadow:0 0 20px rgba(0,255,0,.25); }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    input[type=text]{ flex:1; min-width:180px; padding:10px 12px; border-radius:10px; border:none; }
    button{
      padding:10px 14px; border:none; border-radius:10px; background:var(--green); color:#000;
      font-weight:600; cursor:pointer; transition:filter .15s;
    }
    button.secondary{ background:#202225; color:#fff; border:1px solid #2a2d33 }
    button:disabled{ opacity:.5; cursor:not-allowed }
    button:hover{ filter:brightness(.95) }
    video{ width:100%; max-height:55dvh; background:#000; border-radius:12px; }
    .chips button{ background:#1b1d21; color:#fff }
    .muted{ color:var(--muted) }
    .spacer{ flex:1 }
    .tag{ padding:2px 8px; border-radius:999px; background:#1b1d21; font-size:12px }
    .status{ margin-top:10px; min-height:20px }
    .bar{ height:6px; background:#1b1d21; border-radius:999px; overflow:hidden; margin-top:6px; display:none; }
    .bar > div{ height:100%; width:0%; background:var(--green); }
  </style>
</head>
<body>
  <div class="card">
    <div class="row" style="align-items:center; gap:12px">
      <img src="./logo.png" alt="logo" style="width:42px;height:42px;border-radius:50%;box-shadow:0 0 10px rgba(0,255,0,.5)">
      <div class="spacer"></div>
      <span class="tag">MP4 exporter</span>
    </div>

    <!-- controls -->
    <div class="row" style="margin-top:12px">
      <input id="code" type="text" placeholder="Enter game code e.g. mo2nes1" />
      <button id="loadBtn">Load</button>
    </div>

    <!-- player -->
    <div style="margin-top:12px">
      <video id="vid" controls playsinline></video>
      <div class="muted" style="margin-top:6px">
        Time: <span id="tNow">0:00</span> / <span id="tDur">0:00</span>
      </div>
    </div>

    <!-- A/B + preview -->
    <div class="row" style="margin-top:14px; gap:10px">
      <button id="setA">Set Start (A)</button>
      <button id="setB">Set End (B)</button>
      <div class="muted">A: <span id="valA">—</span> &nbsp; B: <span id="valB">—</span></div>
      <div class="spacer"></div>
      <button class="secondary" id="previewBtn">Preview</button>
      <button class="secondary" id="cancelPreviewBtn">Cancel Preview</button>
      <button id="downloadBtn">Download MP4</button>
    </div>

    <!-- quick jumps -->
    <div class="row chips" style="margin-top:10px">
      <button data-skip="15">+15s</button>
      <button data-skip="30">+30s</button>
      <button data-skip="60">+60s</button>
      <button data-skip="120">+120s</button>
    </div>

    <!-- status -->
    <div class="status" id="status">Idle</div>
    <div class="bar" id="bar"><div></div></div>

    <div class="muted" style="margin-top:10px">
      Tip: set A/B then Preview. Download creates an MP4 clip (H.264/AAC, faststart). iPhone is auto-optimized.
    </div>
  </div>

  <!-- hls.js for non-Safari browsers -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.13/dist/hls.min.js"></script>
  <script>
    // ===== CONFIG =====
    // If you proxy through Vercel: keep API_BASE = ""
    // If you want to call Render directly: set API_BASE = "https://f6boll.onrender.com"
    const API_BASE = "https://f6boll.onrender.com"; // "" -> same origin (/api/*). Or "https://f6boll.onrender.com"
    const HLS_BASE = "https://fision-videos-worker.myfisionupload.workers.dev";
    const PLAYLIST = "stream_0.m3u8";
    // ==================

    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const $ = (id) => document.getElementById(id);

    // ---- elements ----
    const els = {
      code: $("code"),
      load: $("loadBtn"),
      vid: $("vid"),
      tNow: $("tNow"),
      tDur: $("tDur"),
      setA: $("setA"),
      setB: $("setB"),
      valA: $("valA"),
      valB: $("valB"),
      preview: $("previewBtn"),
      cancelPreview: $("cancelPreviewBtn"),
      download: $("downloadBtn"),
      chips: document.querySelectorAll(".chips button"),
      status: $("status"),
      bar: $("bar"),
      barIn: $("bar").firstElementChild
    };

    // ---- state ----
    let A = null, B = null;
    let hls = null;
    let previewTimer = null, prevTime = 0;

    // ---- utils ----
    const fmt = s => {
      s = Math.max(0, s|0);
      const m = (s/60)|0, ss = s%60;
      return m + ":" + String(ss).padStart(2,"0");
    };
    const qp = (k) => new URLSearchParams(location.search).get(k);

    // ---- load video (HLS) ----
    async function loadVideo() {
      const code = (els.code.value || "").trim();
      if (!code) return alert("Enter a game code");
      const src = `${HLS_BASE}/videos/${encodeURIComponent(code)}/${PLAYLIST}`;

      // destroy old instance
      if (hls) { hls.destroy(); hls = null; }
      els.vid.pause(); els.vid.removeAttribute("src"); els.vid.load();

      if (window.Hls && Hls.isSupported()) {
        hls = new Hls({ enableWorker: true });
        hls.loadSource(src);
        hls.attachMedia(els.vid);
      } else if (els.vid.canPlayType("application/vnd.apple.mpegurl")) {
        els.vid.src = src; // Safari
      } else {
        alert("HLS is not supported in this browser.");
      }
    }

    // ---- A/B ----
    function setA(){ A = Math.floor(els.vid.currentTime); els.valA.textContent = fmt(A); }
    function setB(){ B = Math.floor(els.vid.currentTime); els.valB.textContent = fmt(B); }

    // ---- preview ----
    async function previewClip() {
      if (!Number.isFinite(A) || !Number.isFinite(B) || B <= A) {
        return alert("Set valid A and B first.");
      }
      if (previewTimer) cancelPreview();
      prevTime = els.vid.currentTime;
      els.vid.currentTime = A;
      try { await els.vid.play(); } catch {}
      previewTimer = setTimeout(cancelPreview, (B - A) * 1000);
      els.preview.disabled = true;
    }
    function cancelPreview() {
      if (previewTimer) { clearTimeout(previewTimer); previewTimer = null; }
      try { els.vid.pause(); } catch {}
      els.vid.currentTime = prevTime || A || 0;
      els.preview.disabled = false;
    }

    // ---- download with SSE "preparing..." ----
    function downloadClip() {
      const code = (els.code.value || "").trim();
      if (!code || !Number.isFinite(A) || !Number.isFinite(B) || B <= A) {
        return alert("Enter code and set valid A/B times.");
      }

      // Prepare status UI
      els.status.textContent = "Preparing clip… 0%";
      els.bar.style.display = "block";
      els.barIn.style.width = "0%";
      els.download.disabled = true;

      // A progress id and an early-opened window (bypasses popup blockers)
      const pid = Math.random().toString(36).slice(2);
      const dlWin = window.open("about:blank", "_blank");

      const params = new URLSearchParams({
        code,
        start: A.toFixed(2),
        end:   B.toFixed(2),
        pid
      });
      if (isIOS) params.set("solid", "1"); // iPhone-safe MP4

      const clipUrl = `${API_BASE}/clip?${params.toString()}`;
      const sseUrl  = `${API_BASE}/progress/${pid}`;

      // For desktop (non-iOS), we can start the download immediately;
      // SSE will still update "preparing" while server pipes data.
      if (!isIOS) {
        try { dlWin.location.href = clipUrl; } catch {}
      }

      // Start listening to progress
      const es = new EventSource(sseUrl);
      let openedBySSE = false;

      es.onmessage = (e) => {
        try {
          const { pct, done } = JSON.parse(e.data);
          if (pct != null) {
            els.status.textContent = `Preparing clip… ${pct}%`;
            els.barIn.style.width = Math.max(1, Math.min(100, pct)) + "%";
          }
          if (done) {
            els.status.textContent = "Ready — starting download…";
            els.barIn.style.width = "100%";
            es.close();
            if (isIOS && !openedBySSE) {
              openedBySSE = true;
              try { dlWin.location.href = clipUrl; } catch {}
            }
            // Re-enable button a little later
            setTimeout(() => { els.download.disabled = false; }, 800);
          }
        } catch { /* ignore non-JSON events (hello ping) */ }
      };

      // Fallback: if SSE doesn’t connect within 2.5s, just start the download
      const sseTimeout = setTimeout(() => {
        try { es.close(); } catch {}
        if (isIOS && !openedBySSE) {
          try { dlWin.location.href = clipUrl; } catch {}
        }
      }, 2500);

      // Close timeout once we have any SSE message
      es.addEventListener("message", () => clearTimeout(sseTimeout), { once: true });
    }

    // ---- events ----
    els.load.onclick = loadVideo;
    els.setA.onclick = setA;
    els.setB.onclick = setB;
    els.preview.onclick = previewClip;
    els.cancelPreview.onclick = cancelPreview;
    els.download.onclick = downloadClip;
    els.chips.forEach(b => b.onclick = () => { els.vid.currentTime += Number(b.dataset.skip); });

    els.vid.addEventListener("timeupdate", () => { els.tNow.textContent = fmt(els.vid.currentTime|0); });
    els.vid.addEventListener("loadedmetadata", () => { els.tDur.textContent = fmt(els.vid.duration|0); });

    // ---- boot from ?code=... if present ----
    const qCode = qp("code");
    if (qCode) { els.code.value = qCode; loadVideo(); }
  </script>
</body>
</html>

